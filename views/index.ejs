<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .section {
        margin-bottom: 30px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      .hidden {
        display: none;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
      }
      button {
        margin: 5px;
        padding: 5px 10px;
      }
      input,
      textarea,
      select {
        margin: 5px 0;
        padding: 5px;
        width: 300px;
      }
      .response {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 5px;
        margin-top: 10px;
        white-space: pre-wrap;
      }
      .error {
        background: #ffe6e6;
        border: 1px solid #ff9999;
        color: #cc0000;
      }
      .success {
        background: #e6ffe6;
        border: 1px solid #99ff99;
        color: #006600;
      }
    </style>
  </head>
  <body>
    <h1>RAG ç³»çµ±æ¸¬è©¦ç•Œé¢</h1>

    <!-- é€£æ¥ç‹€æ…‹æª¢æŸ¥ -->
    <div class="section">
      <h2>ç³»çµ±ç‹€æ…‹æª¢æŸ¥</h2>
      <button id="checkStatusBtn">æª¢æŸ¥å¾Œç«¯é€£æ¥</button>
      <div class="response" id="statusResponse"></div>
    </div>

    <!-- ç™»éŒ„éƒ¨åˆ† -->
    <div class="section" id="loginSection">
      <h2>1. ç”¨æˆ¶ç™»éŒ„</h2>
      <form id="loginForm">
        <div>
          <label for="username">ç”¨æˆ¶å:</label>
          <input
            type="text"
            id="username"
            required
            placeholder="è«‹è¼¸å…¥ç”¨æˆ¶å"
          />
        </div>
        <div>
          <label for="password">å¯†ç¢¼:</label>
          <input
            type="password"
            id="password"
            required
            placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
          />
        </div>
        <button type="submit">ç™»éŒ„</button>
      </form>
      <div class="response" id="loginResponse"></div>

      <!-- æ·»åŠ è¨»å†Šé¸é … -->
      <div style="margin-top: 15px">
        <h3>é‚„æ²’æœ‰è³¬è™Ÿï¼Ÿ</h3>
        <form id="registerForm">
          <div>
            <label for="regUsername">ç”¨æˆ¶å:</label>
            <input
              type="text"
              id="regUsername"
              required
              placeholder="è«‹è¼¸å…¥ç”¨æˆ¶å"
            />
          </div>
          <div>
            <label for="regPassword">å¯†ç¢¼:</label>
            <input
              type="password"
              id="regPassword"
              required
              placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
            />
          </div>
          <div>
            <label for="confirmPassword">ç¢ºèªå¯†ç¢¼:</label>
            <input
              type="password"
              id="confirmPassword"
              required
              placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼"
            />
          </div>
          <button type="submit">è¨»å†Š</button>
        </form>
        <div class="response" id="registerResponse"></div>
      </div>
    </div>

    <!-- ç™»éŒ„å¾Œé¡¯ç¤ºçš„éƒ¨åˆ† -->
    <div class="hidden" id="authenticatedSection">
      <!-- ç”¨æˆ¶ä¿¡æ¯ -->
      <div class="section">
        <h2>ç”¨æˆ¶ä¿¡æ¯</h2>
        <!-- é ­åƒé¡¯ç¤ºå€ -->
        <div>
          <img
            id="userAvatar"
            src="/stylesheets/default-avatar.jpg"
            alt="é ­åƒ"
            style="
              width: 80px;
              height: 80px;
              border-radius: 30%;
              border: 1px solid #ccc;
            "
          />
        </div>
        <div id="userInfo">å°šæœªç™»éŒ„</div>
        <button id="logoutBtn">ç™»å‡º</button>
        <!-- ä¸Šå‚³é ­åƒè¡¨å–® -->
        <form
          id="avatarUploadForm"
          enctype="multipart/form-data"
          style="margin-top: 10px"
        >
          <input
            type="file"
            id="avatarFile"
            name="avatar"
            accept="image/*"
            required
          />
          <button type="submit">ä¸Šå‚³é ­åƒ</button>
        </form>
        <div class="response" id="avatarUploadResponse"></div>
      </div>

      <!-- RAG Engine ç®¡ç† -->
      <div class="section">
        <h2>2. RAG Engine ç®¡ç†</h2>

        <!-- å‰µå»º RAG Engine -->
        <div>
          <h3>å‰µå»ºæ–° RAG Engine</h3>
          <form id="createEngineForm">
            <div>
              <label for="engineName">å¼•æ“åç¨±:</label>
              <input type="text" id="engineName" required />
            </div>
            <div>
              <label for="engineDescription">æè¿° (é¸å¡«):</label>
              <input type="text" id="engineDescription" />
            </div>
            <button type="submit">å‰µå»º RAG Engine</button>
          </form>
          <div class="response" id="createEngineResponse"></div>
        </div>

        <!-- åˆ—å‡ºç”¨æˆ¶çš„ RAG Engines -->
        <div>
          <h3>æˆ‘çš„ RAG Engines</h3>
          <button id="listEnginesBtn">åˆ·æ–°åˆ—è¡¨</button>
          <div class="response" id="listEnginesResponse"></div>
          <table id="enginesTable">
            <thead>
              <tr>
                <th>ID</th>
                <th>åç¨±</th>
                <th>å¯è¦‹æ€§</th>
                <th>å»ºç«‹æ—¥æœŸ</th>
                <th>æ“ä½œ</th>
                <th>æ“ä½œ</th>
                <th>åˆ†äº«</th>
              </tr>
            </thead>
            <tbody id="enginesTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- æ–‡ä»¶ç®¡ç† -->
      <div class="section">
        <h2>3. æ–‡ä»¶ç®¡ç†</h2>

        <!-- ä¸Šå‚³æ–‡ä»¶ -->
        <div>
          <h3>ä¸Šå‚³æ–‡ä»¶åˆ° RAG Engine</h3>
          <form id="uploadFileForm" enctype="multipart/form-data">
            <div>
              <label for="engineForUpload">é¸æ“‡ RAG Engine:</label>
              <select id="engineForUpload" required></select>
            </div>
            <div>
              <label for="fileToUpload">é¸æ“‡æ–‡ä»¶ (æ”¯æ´å¤šå€‹æ–‡ä»¶):</label>
              <input type="file" id="fileToUpload" name="file" multiple />
            </div>
            <button type="submit">ä¸Šå‚³æ–‡ä»¶</button>
          </form>
          <div class="response" id="uploadFileResponse"></div>
        </div>

        <!-- åˆ—å‡ºå¼•æ“çš„æ–‡ä»¶ -->
        <div>
          <h3>æŸ¥çœ‹ RAG Engine ä¸­çš„æ–‡ä»¶</h3>
          <div>
            <label for="engineForDocuments">é¸æ“‡ RAG Engine:</label>
            <select id="engineForDocuments"></select>
            <button id="listDocumentsBtn">ç²å–æ–‡æª”åˆ—è¡¨</button>
          </div>
          <div class="response" id="listDocumentsResponse"></div>
          <table id="documentsTable">
            <thead>
              <tr>
                <th>æ–‡ä»¶ID</th>
                <th>åŸå§‹æ–‡ä»¶å</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="documentsTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- æŸ¥è©¢åŠŸèƒ½ -->
      <div class="section">
        <h2>4. RAG æŸ¥è©¢</h2>
        <form id="queryForm">
          <div>
            <label for="engineForQuery">é¸æ“‡ RAG Engine:</label>
            <select id="engineForQuery"></select>
          </div>
          <div>
            <label for="question">æå•:</label>
            <textarea id="question" rows="4" required></textarea>
          </div>
          <button type="submit">ç™¼é€æŸ¥è©¢</button>
        </form>
        <div class="response" id="queryResponse"></div>
      </div>
    </div>

    <script>
      // å…¨å±€è®Šé‡
      let authToken = localStorage.getItem("authToken");
      let currentUserId = localStorage.getItem("userId");
      let userEngines = [];

      // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        checkAuthStatus();

        // äº‹ä»¶ç›£è½å™¨è¨­ç½®
        document
          .getElementById("checkStatusBtn")
          .addEventListener("click", checkBackendStatus);
        document
          .getElementById("loginForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            login();
          });
        document
          .getElementById("registerForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            register();
          });
        document.getElementById("logoutBtn").addEventListener("click", logout);
        document
          .getElementById("createEngineForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            createEngine();
          });
        document
          .getElementById("listEnginesBtn")
          .addEventListener("click", listEngines);
        document
          .getElementById("uploadFileForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            uploadFile();
          });
        document
          .getElementById("listDocumentsBtn")
          .addEventListener("click", listDocuments);
        document
          .getElementById("queryForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            queryEngine();
          });
        document
          .getElementById("avatarUploadForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            uploadAvatar();
          });

        async function uploadAvatar() {
          if (!currentUserId) {
            document.getElementById("avatarUploadResponse").textContent =
              "è«‹å…ˆç™»å…¥";
            document.getElementById("avatarUploadResponse").className =
              "response error";
            return;
          }
          const fileInput = document.getElementById("avatarFile");
          if (fileInput.files.length === 0) {
            document.getElementById("avatarUploadResponse").textContent =
              "è«‹é¸æ“‡åœ–ç‰‡";
            document.getElementById("avatarUploadResponse").className =
              "response error";
            return;
          }
          const formData = new FormData();
          formData.append("avatar", fileInput.files[0]);
          formData.append("userId", currentUserId);

          try {
            const response = await fetch("/api/users/avatar", {
              method: "POST",
              body: formData,
            });
            const data = await response.json();
            if (data.success) {
              document.getElementById("avatarUploadResponse").textContent =
                "é ­åƒä¸Šå‚³æˆåŠŸ";
              document.getElementById("avatarUploadResponse").className =
                "response success";
            } else {
              document.getElementById("avatarUploadResponse").textContent =
                "ä¸Šå‚³å¤±æ•—: " + data.error;
              document.getElementById("avatarUploadResponse").className =
                "response error";
            }
          } catch (error) {
            document.getElementById("avatarUploadResponse").textContent =
              "éŒ¯èª¤: " + error.message;
            document.getElementById("avatarUploadResponse").className =
              "response error";
          }
        }

        // ç™»éŒ„å¾Œè‡ªå‹•è¼‰å…¥é ­åƒ
        async function loadUserAvatar() {
          if (!currentUserId) return;
          try {
            const response = await fetch(
              "/api/users/" + currentUserId + "/avatar"
            );
            const data = await response.json();
            // ç„¡è«– success èˆ‡å¦éƒ½ç”¨ data.avatarurl
            document.getElementById("userAvatar").src = data.avatarurl || "/stylesheets/default-avatar.jpg";
          } catch {
            document.getElementById("userAvatar").src = "/stylesheets/default-avatar.jpg";
          }
        }

        // åœ¨ checkAuthStatus() è£¡åŠ è¼‰é ­åƒ
        function checkAuthStatus() {
          if (authToken && currentUserId) {
            document.getElementById("loginSection").classList.add("hidden");
            document
              .getElementById("authenticatedSection")
              .classList.remove("hidden");
            document.getElementById("userInfo").textContent =
              "ç•¶å‰ç”¨æˆ¶ ID: " + currentUserId;
            loadUserAvatar();
            listEngines();
          } else {
            document.getElementById("loginSection").classList.remove("hidden");
            document
              .getElementById("authenticatedSection")
              .classList.add("hidden");
            document.getElementById("userAvatar").src = "/default-avatar.jpg";
          }
        }

        // åˆå§‹ç‹€æ…‹æª¢æŸ¥
        checkBackendStatus();
      });

      // æª¢æŸ¥å¾Œç«¯ç‹€æ…‹
      async function checkBackendStatus() {
        try {
          document.getElementById("statusResponse").textContent = "æª¢æŸ¥ä¸­...";

          const response = await fetch("/", {
            method: "GET",
          });

          if (response.ok) {
            document.getElementById("statusResponse").textContent =
              "âœ… å¾Œç«¯é€£æ¥æ­£å¸¸ (ç‹€æ…‹ç¢¼: " + response.status + ")";
            document.getElementById("statusResponse").className =
              "response success";
          } else {
            document.getElementById("statusResponse").textContent =
              "âŒ å¾Œç«¯ç‹€æ…‹ç•°å¸¸ (ç‹€æ…‹ç¢¼: " + response.status + ")";
            document.getElementById("statusResponse").className =
              "response error";
          }
        } catch (error) {
          document.getElementById("statusResponse").textContent =
            "âŒ ç„¡æ³•é€£æ¥å¾Œç«¯: " + error.message;
          document.getElementById("statusResponse").className =
            "response error";
        }
      }

      // æª¢æŸ¥èªè­‰ç‹€æ…‹
      function checkAuthStatus() {
        if (authToken && currentUserId) {
          document.getElementById("loginSection").classList.add("hidden");
          document
            .getElementById("authenticatedSection")
            .classList.remove("hidden");
          document.getElementById("userInfo").textContent =
            "ç•¶å‰ç”¨æˆ¶ ID: " + currentUserId;
          loadUserAvatar();
          listEngines();
        } else {
          document.getElementById("loginSection").classList.remove("hidden");
          document
            .getElementById("authenticatedSection")
            .classList.add("hidden");
          document.getElementById("userAvatar").src = "/stylesheets/default-avatar.jpg";
        }
      }

      // è¨»å†ŠåŠŸèƒ½
      async function register() {
        const username = document.getElementById("regUsername").value;
        const password = document.getElementById("regPassword").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        if (password !== confirmPassword) {
          document.getElementById("registerResponse").textContent =
            "å¯†ç¢¼ç¢ºèªä¸åŒ¹é…";
          document.getElementById("registerResponse").className =
            "response error";
          return;
        }

        try {
          const response = await fetch("/api/auth/register", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              username: username,
              password: password,
              confirmPassword: confirmPassword,
            }),
          });

          const data = await response.json();
          document.getElementById("registerResponse").textContent =
            JSON.stringify(data, null, 2);

          if (data.success && data.token) {
            authToken = data.token;
            currentUserId = data.user.userid;
            localStorage.setItem("authToken", authToken);
            localStorage.setItem("userId", currentUserId);
            document.getElementById("registerResponse").className =
              "response success";
            setTimeout(function () {
              checkAuthStatus();
            }, 1000);
          } else {
            document.getElementById("registerResponse").className =
              "response error";
          }
        } catch (error) {
          document.getElementById("registerResponse").textContent =
            "Error: " + error.message;
          document.getElementById("registerResponse").className =
            "response error";
        }
      }

      // ç™»éŒ„åŠŸèƒ½
      async function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        try {
          document.getElementById("loginResponse").textContent = "ç™»éŒ„ä¸­...";

          const response = await fetch("/api/auth/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ username: username, password: password }),
          });

          const data = await response.json();
          document.getElementById("loginResponse").textContent = JSON.stringify(
            data,
            null,
            2
          );

          if (data.success && data.token) {
            authToken = data.token;
            currentUserId = data.user.userid;
            localStorage.setItem("authToken", authToken);
            localStorage.setItem("userId", currentUserId);
            document.getElementById("loginResponse").className =
              "response success";
            checkAuthStatus();
          } else {
            document.getElementById("loginResponse").className =
              "response error";
          }
        } catch (error) {
          document.getElementById("loginResponse").textContent =
            "Error: " + error.message;
          document.getElementById("loginResponse").className = "response error";
        }
      }

      // ç™»å‡ºåŠŸèƒ½
      function logout() {
        localStorage.removeItem("authToken");
        localStorage.removeItem("userId");
        authToken = null;
        currentUserId = null;
        checkAuthStatus();
      }

      // å‰µå»º RAG Engine
      async function createEngine() {
        const engineName = document.getElementById("engineName").value;
        const description = document.getElementById("engineDescription").value;

        try {
          const response = await fetch("/api/rag/users/engines", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + authToken,
            },
            body: JSON.stringify({
              engineName: engineName,
              description: description,
            }),
          });

          const data = await response.json();
          document.getElementById("createEngineResponse").textContent =
            JSON.stringify(data, null, 2);

          if (data.success) {
            document.getElementById("createEngineResponse").className =
              "response success";
            document.getElementById("engineName").value = "";
            document.getElementById("engineDescription").value = "";
            listEngines();
          } else {
            document.getElementById("createEngineResponse").className =
              "response error";
          }
        } catch (error) {
          document.getElementById("createEngineResponse").textContent =
            "Error: " + error.message;
          document.getElementById("createEngineResponse").className =
            "response error";
        }
      }

      // åˆ—å‡ºç”¨æˆ¶çš„ RAG Engines
      async function listEngines() {
        try {
          const response = await fetch(
            "/api/rag/users/" + currentUserId + "/engines",
            {
              method: "GET",
              headers: {
                Authorization: "Bearer " + authToken,
              },
            }
          );

          const data = await response.json();
          document.getElementById("listEnginesResponse").textContent =
            JSON.stringify(data, null, 2);

          if (data.success) {
            userEngines = data.engines;
            populateEnginesTable(data.engines);
            populateEngineSelects(data.engines);
            document.getElementById("listEnginesResponse").className =
              "response success";
          } else {
            document.getElementById("listEnginesResponse").className =
              "response error";
          }
        } catch (error) {
          document.getElementById("listEnginesResponse").textContent =
            "Error: " + error.message;
          document.getElementById("listEnginesResponse").className =
            "response error";
        }
      }

      // å¡«å……å¼•æ“è¡¨æ ¼
      function populateEnginesTable(engines) {
        const tableBody = document.getElementById("enginesTableBody");
        tableBody.innerHTML = "";

        engines.forEach(function (engine) {
          const row = document.createElement("tr");

          const idCell = document.createElement("td");
          idCell.textContent = engine.id;
          row.appendChild(idCell);

          const nameCell = document.createElement("td");
          nameCell.textContent = engine.name;
          row.appendChild(nameCell);

          const visibilityCell = document.createElement("td");
          visibilityCell.textContent = engine.visibility || "private";
          row.appendChild(visibilityCell);

          const createdAtCell = document.createElement("td");
          createdAtCell.textContent = new Date(
            engine.createdAt
          ).toLocaleString();
          row.appendChild(createdAtCell);

          const actionsCell = document.createElement("td");
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "åˆªé™¤";
          deleteBtn.onclick = function () {
            deleteEngine(engine.id);
          };
          actionsCell.appendChild(deleteBtn);
          row.appendChild(actionsCell);

          // æ–°å¢åˆ†äº«æ¬„ä½
          const shareCell = document.createElement("td");
          const shareInput = document.createElement("input");
          shareInput.type = "text";
          shareInput.placeholder = "å°æ–¹ userId";
          shareInput.style.width = "120px";
          shareCell.appendChild(shareInput);

          const shareBtn = document.createElement("button");
          shareBtn.textContent = "åˆ†äº«";
          shareBtn.onclick = async function () {
            const targetUserId = shareInput.value.trim();
            if (!targetUserId) {
              alert("è«‹è¼¸å…¥å°æ–¹ userId");
              return;
            }
            shareBtn.disabled = true;
            shareBtn.textContent = "åˆ†äº«ä¸­...";
            try {
              const response = await fetch(
                "/api/rag/users/engines/" + engine.id + "/share",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                    Authorization: "Bearer " + authToken,
                  },
                  body: JSON.stringify({ targetUserId: targetUserId }),
                }
              );
              const data = await response.json();
              if (data.success) {
                alert("åˆ†äº«æˆåŠŸï¼");
              } else {
                alert("åˆ†äº«å¤±æ•—: " + data.error);
              }
            } catch (error) {
              alert("åˆ†äº«éŒ¯èª¤: " + error.message);
            }
            shareBtn.disabled = false;
            shareBtn.textContent = "åˆ†äº«";
          };
          shareCell.appendChild(shareBtn);
          row.appendChild(shareCell);

          tableBody.appendChild(row);
        });
      }

      // å¡«å……å¼•æ“ä¸‹æ‹‰é¸å–®
      function populateEngineSelects(engines) {
        const selects = [
          document.getElementById("engineForUpload"),
          document.getElementById("engineForDocuments"),
          document.getElementById("engineForQuery"),
        ];

        selects.forEach(function (select) {
          select.innerHTML = "";
          engines.forEach(function (engine) {
            const option = document.createElement("option");
            option.value = engine.id;
            option.textContent = engine.name;
            select.appendChild(option);
          });
        });
      }

      // åˆªé™¤ RAG Engine
      async function deleteEngine(engineId) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤ ID ç‚º " + engineId + " çš„ RAG Engine å—ï¼Ÿ")) {
          return;
        }

        try {
          const response = await fetch(
            "/api/rag/users/" + currentUserId + "/engines/" + engineId,
            {
              method: "DELETE",
              headers: {
                Authorization: "Bearer " + authToken,
              },
            }
          );

          const data = await response.json();

          if (data.success) {
            alert("RAG Engine å·²æˆåŠŸåˆªé™¤");
            listEngines();
          } else {
            alert("åˆªé™¤å¤±æ•—: " + data.error);
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      // ä¸Šå‚³æ–‡ä»¶å‡½æ•¸
      async function uploadFile() {
        const engineId = document.getElementById("engineForUpload").value;
        const fileInput = document.getElementById("fileToUpload");

        if (!engineId) {
          alert("è«‹é¸æ“‡ä¸€å€‹ RAG Engine");
          return;
        }

        if (fileInput.files.length === 0) {
          alert("è«‹é¸æ“‡è‡³å°‘ä¸€å€‹æ–‡ä»¶");
          return;
        }

        const totalFiles = fileInput.files.length;
        let successCount = 0;
        let failCount = 0;

        for (let i = 0; i < fileInput.files.length; i++) {
          const file = fileInput.files[i];

          try {
            document.getElementById("uploadFileResponse").textContent =
              "ä¸Šå‚³æ–‡ä»¶ " +
              (i + 1) +
              "/" +
              totalFiles +
              ": " +
              file.name +
              "ï¼Œè«‹ç¨å€™...";

            const formData = new FormData();
            formData.append("file", file);
            formData.append("ragId", engineId);

            const response = await fetch(
              "/api/rag/users/" + currentUserId + "/upload",
              {
                method: "POST",
                headers: {
                  Authorization: "Bearer " + authToken,
                },
                body: formData,
              }
            );

            const data = await response.json();

            if (data.success) {
              successCount++;
              document.getElementById("uploadFileResponse").textContent +=
                "\nâœ… " + file.name + " ä¸Šå‚³æˆåŠŸ";
              document.getElementById("uploadFileResponse").className =
                "response success";
            } else {
              failCount++;
              document.getElementById("uploadFileResponse").textContent +=
                "\nâŒ " + file.name + " ä¸Šå‚³å¤±æ•—: " + data.error;
              document.getElementById("uploadFileResponse").className =
                "response error";
            }
          } catch (error) {
            failCount++;
            document.getElementById("uploadFileResponse").textContent +=
              "\nâŒ " + file.name + " ä¸Šå‚³éŒ¯èª¤: " + error.message;
            document.getElementById("uploadFileResponse").className =
              "response error";
          }
        }

        fileInput.value = "";
        document.getElementById("uploadFileResponse").textContent +=
          "\n\nğŸ“Š ä¸Šå‚³å®Œæˆï¼ç¸½å…±è™•ç† " +
          totalFiles +
          " å€‹æ–‡ä»¶ï¼ˆæˆåŠŸï¼š" +
          successCount +
          "ï¼Œå¤±æ•—ï¼š" +
          failCount +
          "ï¼‰";
      }

      // åˆ—å‡ºæ–‡ä»¶
      async function listDocuments() {
        const engineId = document.getElementById("engineForDocuments").value;

        if (!engineId) {
          alert("è«‹é¸æ“‡ä¸€å€‹ RAG Engine");
          return;
        }

        try {
          const response = await fetch(
            "/api/rag/users/" +
              currentUserId +
              "/engines/" +
              engineId +
              "/documents",
            {
              method: "GET",
              headers: {
                Authorization: "Bearer " + authToken,
              },
            }
          );

          const data = await response.json();
          document.getElementById("listDocumentsResponse").textContent =
            JSON.stringify(data, null, 2);

          if (data.success) {
            let documentsList = [];

            if (Array.isArray(data.documents)) {
              documentsList = data.documents;
            } else if (data.documents && typeof data.documents === "object") {
              documentsList = Object.entries(data.documents).map(function (
                entry
              ) {
                return {
                  id: entry[0],
                  fileId: entry[0],
                  originalFileName: entry[1],
                  displayName: entry[1],
                  filename: entry[1],
                };
              });
            } else {
              documentsList = [];
            }

            populateDocumentsTable(documentsList, engineId);
            document.getElementById("listDocumentsResponse").className =
              "response success";
          } else {
            document.getElementById("listDocumentsResponse").className =
              "response error";
          }
        } catch (error) {
          document.getElementById("listDocumentsResponse").textContent =
            "Error: " + error.message;
          document.getElementById("listDocumentsResponse").className =
            "response error";
        }
      }

      // å¡«å……æ–‡ä»¶è¡¨æ ¼å‡½æ•¸
      function populateDocumentsTable(documents, engineId) {
        const tableBody = document.getElementById("documentsTableBody");
        tableBody.innerHTML = "";

        if (!Array.isArray(documents)) {
          console.error("Documents is not an array:", documents);
          const noDataRow = document.createElement("tr");
          const noDataCell = document.createElement("td");
          noDataCell.colSpan = 3;
          noDataCell.textContent = "æ²’æœ‰æ‰¾åˆ°æ–‡ä»¶æˆ–æ•¸æ“šæ ¼å¼éŒ¯èª¤";
          noDataRow.appendChild(noDataCell);
          tableBody.appendChild(noDataRow);
          return;
        }

        if (documents.length === 0) {
          const noDataRow = document.createElement("tr");
          const noDataCell = document.createElement("td");
          noDataCell.colSpan = 3;
          noDataCell.textContent = "æ­¤ RAG Engine ä¸­æ²’æœ‰æ–‡ä»¶";
          noDataRow.appendChild(noDataCell);
          tableBody.appendChild(noDataRow);
          return;
        }

        documents.forEach(function (doc) {
          const row = document.createElement("tr");

          const idCell = document.createElement("td");
          idCell.textContent = doc.fileId || doc.id || "N/A";
          row.appendChild(idCell);

          const nameCell = document.createElement("td");
          nameCell.textContent =
            doc.originalFileName ||
            doc.displayName ||
            doc.filename ||
            doc.name ||
            "Unknown";
          row.appendChild(nameCell);

          const actionsCell = document.createElement("td");
          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "åˆªé™¤";
          deleteBtn.onclick = function () {
            deleteDocument(doc.fileId || doc.id, engineId);
          };
          actionsCell.appendChild(deleteBtn);
          row.appendChild(actionsCell);

          tableBody.appendChild(row);
        });
      }

      // åˆªé™¤æ–‡ä»¶
      async function deleteDocument(fileId, engineId) {
        if (!confirm("ç¢ºå®šè¦åˆªé™¤ ID ç‚º " + fileId + " çš„æ–‡ä»¶å—ï¼Ÿ")) {
          return;
        }

        try {
          const response = await fetch(
            "/api/rag/users/documents/" + fileId + "?ragId=" + engineId,
            {
              method: "DELETE",
              headers: {
                Authorization: "Bearer " + authToken,
              },
            }
          );

          const data = await response.json();

          if (data.success) {
            alert("æ–‡ä»¶å·²æˆåŠŸåˆªé™¤");
            listDocuments();
          } else {
            alert("åˆªé™¤å¤±æ•—: " + data.error);
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }

      // æŸ¥è©¢ RAG Engine
      async function queryEngine() {
        const engineId = document.getElementById("engineForQuery").value;
        const question = document.getElementById("question").value;

        if (!engineId) {
          alert("è«‹é¸æ“‡ä¸€å€‹ RAG Engine");
          return;
        }

        if (!question.trim()) {
          alert("è«‹è¼¸å…¥å•é¡Œ");
          return;
        }

        try {
          document.getElementById("queryResponse").textContent =
            "è™•ç†ä¸­ï¼Œè«‹ç¨å€™...";

          const response = await fetch(
            "/api/rag/users/" +
              currentUserId +
              "/engines/" +
              engineId +
              "/query",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: "Bearer " + authToken,
              },
              body: JSON.stringify({ question: question }),
            }
          );

          const data = await response.json();

          let formattedResponse;
          if (data.success) {
            formattedResponse =
              "å•é¡Œ: " + question + "\n\nå›ç­”: " + data.answer + "\n\nä¾†æº:";

            if (data.sources && data.sources.length > 0) {
              data.sources.forEach(function (source, index) {
                formattedResponse +=
                  "\n" +
                  (index + 1) +
                  ". " +
                  (source.title || source.name || "Unknown");
              });
            } else {
              formattedResponse += "\nç„¡ç‰¹å®šä¾†æº";
            }

            formattedResponse +=
              "\n\næ™‚é–“æˆ³: " + new Date(data.timestamp).toLocaleString();
            document.getElementById("queryResponse").className =
              "response success";
          } else {
            formattedResponse = "éŒ¯èª¤: " + data.error;
            document.getElementById("queryResponse").className =
              "response error";
          }

          document.getElementById("queryResponse").textContent =
            formattedResponse;
        } catch (error) {
          document.getElementById("queryResponse").textContent =
            "Error: " + error.message;
          document.getElementById("queryResponse").className = "response error";
        }
      }
    </script>
  </body>
</html>
